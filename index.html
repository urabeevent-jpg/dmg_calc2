<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQX é˜²è¡›ç”¨ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—æ©Ÿ</title>
    <style>
        /* â–¼â–¼â–¼ ãƒ†ãƒ¼ãƒå¤‰æ•°å®šç¾© â–¼â–¼â–¼ */
        :root {
            /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) */
            --bg-body: #12121c;
            --text-main: #fff;
            --text-sub: #aaa;
            --text-muted: #666;
            
            --bg-panel: rgba(30, 30, 40, 0.95);
            --border-panel: rgba(255,255,255,0.1);
            --shadow-panel: rgba(0,0,0,0.5);

            --bg-result: linear-gradient(145deg, #0f3460, #16213e);
            --border-result: #ff2a6d;
            
            --bg-input: #252f3f;
            --bg-input-fixed: #1a1a20;
            --text-input: #fff;
            --border-input-focus: #4da6ff;

            --btn-bg: #1f1f2e;
            --btn-border: #444;
            --btn-text: #888;
            --btn-hover: #2f2f3e;

            --accent-pink: #ff2a6d;
            --accent-cyan: #05d9e8;
            --accent-orange: #ff9f1c;
            --accent-yellow: #ffd700;
            --accent-green: #00ff9d;

            --beam-color: cyan;
        }

        /* ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ */
        [data-theme="light"] {
            --bg-body: #f0f2f5;
            --text-main: #333;
            --text-sub: #555;
            --text-muted: #999;
            
            --bg-panel: #ffffff;
            --border-panel: #ccc;
            --shadow-panel: rgba(0,0,0,0.1);

            --bg-result: linear-gradient(145deg, #ffffff, #e6e9f0);
            --border-result: #ff2a6d;
            
            --bg-input: #fff;
            --bg-input-fixed: #e9ecef;
            --text-input: #333;
            --border-input-focus: #007bff;

            --btn-bg: #f8f9fa;
            --btn-border: #ccc;
            --btn-text: #666;
            --btn-hover: #e2e6ea;

            --accent-pink: #d60058;
            --accent-cyan: #008c9e;
            --accent-orange: #ff1e00ff;
            --accent-yellow: #ff3300ff;
            --accent-green: #00a651;
            
            --beam-color: #00bfff;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 80px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢èª¿æ•´ */
        .header-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        h1 { 
            margin: 0; 
            font-size: 1.5rem; 
            color: var(--accent-pink); 
            text-shadow: 0 0 10px rgba(255, 42, 109, 0.3); 
        }

        /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .theme-toggle {
            background: var(--bg-panel);
            border: 1px solid var(--border-panel);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px var(--shadow-panel);
            transition: all 0.2s;
        }
        .theme-toggle:hover { transform: scale(1.1); }

        .calculator-container {
            width: 100%;
            max-width: 720px;
            position: relative;
        }

        .step-section {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-panel);
            z-index: 2;
            box-shadow: 0 4px 10px var(--shadow-panel);
            transition: background 0.3s, border 0.3s;
        }
        
        .step-left { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .step-label { font-weight: bold; font-size: 1rem; color: var(--text-main); display: flex; align-items: center; gap: 6px; margin-bottom: 5px;}
        .step-icon { font-size: 1.3rem; }
        
        .input-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .input-item { display: flex; flex-direction: column; font-size: 0.75rem; color: var(--text-sub); }
        .input-item.item-full { width: 100%; margin-bottom: 8px; border-bottom: 1px dashed var(--btn-border); padding-bottom: 8px; }

        .step-result {
            text-align: right;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 1.2rem;
            color: var(--accent-cyan);
            min-width: 95px;
            margin-top: 5px;
            text-shadow: 0 0 5px rgba(5, 217, 232, 0.2);
        }
        
        .step-result small { 
            display: block; 
            font-size: 1.1rem; 
            color: var(--accent-yellow);   
            font-family: sans-serif; 
            margin-top: 4px;
            font-weight: bold; 
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.4); 
            letter-spacing: 0.5px;
        }

        .beam-connector {
            height: 20px;
            margin: 0 auto;
            background: var(--beam-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 0 15px var(--beam-color);
            position: relative;
            z-index: 1;
            min-height: 5px;
        }

        .result-panel {
            margin-top: 0px;
            background: var(--bg-result);
            border-radius: 15px;
            border: 2px solid var(--border-result);
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 3;
            box-shadow: 0 0 20px rgba(255, 42, 109, 0.15);
            color: var(--text-main);
        }

        .total-multiplier { font-size: 1.5rem; color: var(--accent-orange); font-weight: bold; margin-bottom: 5px; grid-column: 1 / -1; }
        
        .final-damage { font-size: 4rem; font-weight: bold; color: var(--accent-green); line-height: 1.1; margin: 10px 0; text-shadow: 0 0 20px rgba(0, 255, 157, 0.25); }
        .final-label { font-size: 1rem; color: var(--text-sub); letter-spacing: 2px; }
        
        .detail-toggle-btn {
            background: none; border: none; color: var(--text-sub); cursor: pointer;
            font-size: 1.1rem; font-weight: bold;
            text-decoration: underline; margin-top: 15px; padding: 8px;
        }
        .detail-toggle-btn:hover { color: var(--text-main); }
        
        .hit-detail-box {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid var(--btn-border);
            text-align: left;
            font-size: 1.05rem;
            max-height: 400px;
            overflow-y: auto;
            color: var(--text-main);
        }
        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯èƒŒæ™¯ã‚’æ¿ƒãã—ã¦æ–‡å­—ã‚’è¦‹ã‚„ã™ã */
        [data-theme="light"] .hit-detail-box {
            background: rgba(0,0,0,0.05);
            border-color: #ccc;
        }

        .hit-row { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed var(--btn-border); }
        .hit-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .hit-header { color: var(--accent-orange); font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem;}
        .hit-vals { font-family: "Consolas", monospace; display: grid; grid-template-columns: auto 1fr; gap: 5px 15px;}
        .v-label { color: var(--text-sub); }
        .v-num { color: var(--text-main); text-align: right; }
        .v-crit { color: var(--accent-pink); font-weight: bold; }
        
        .process-info {
            grid-column: 1 / -1;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dotted var(--btn-border);
            font-family: "Consolas", monospace;
            word-break: break-all;
            line-height: 1.5;
        }
        .process-tag { color: var(--accent-cyan); font-weight: bold; margin-right: 4px; }
        
        .crit-compare-block {
            margin-top: 6px;
            padding-left: 8px;
            border-left: 2px solid var(--btn-border);
            background: rgba(0,0,0,0.05);
            border-radius: 0 4px 4px 0;
        }
        .crit-row { color: var(--text-sub); font-size: 0.8rem; margin-bottom: 4px; padding: 4px; font-family: "Consolas", monospace;}
        .crit-row.selected { color: var(--text-main); background: rgba(255, 42, 109, 0.1); border-radius: 4px; border: 1px solid rgba(255, 42, 109, 0.3);}
        .crit-row.selected .crit-tag { color: var(--accent-pink); }
        
        .crit-tag { display: inline-block; width: 25px; font-weight: bold; color: var(--text-muted);}
        .crit-detail { color: var(--text-sub); margin-right: 5px; }
        .crit-result-part { font-weight: bold; color: var(--text-main); white-space: nowrap;}
        
        .hand-tag { font-size: 0.9rem; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }
        .hand-l { background: rgba(5, 217, 232, 0.1); color: var(--accent-cyan); border: 1px solid var(--accent-cyan); }
        .c-type { font-size: 0.8rem; color: var(--accent-pink); margin-left: 5px; font-weight: normal; }

        .compare-tools {
            margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--btn-border);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .btn-snapshot {
            background: var(--btn-bg); color: var(--text-main); border: 1px solid var(--btn-border);
            padding: 8px 25px; border-radius: 20px; cursor: pointer; transition: 0.2s;
        }
        .btn-snapshot:hover { background: var(--btn-hover); }
        
        .diff-display {
            font-size: 1rem; font-weight: bold; display: none;
            padding: 5px 15px; border-radius: 5px; background: var(--bg-panel); border: 1px solid var(--border-panel); color: var(--text-main);
        }
        .diff-plus { color: var(--accent-green); } .diff-minus { color: #ff3860; } .diff-even { color: var(--text-sub); }

        input[type="number"] { 
            padding: 5px; width: 65px; border-radius: 4px; border: none; 
            text-align: right; font-size: 0.9rem;
            transition: all 0.2s;
            color: var(--text-input);
        }
        
        input.fixed-val {
            background: var(--bg-input-fixed); color: var(--text-muted); border: 1px solid var(--btn-border);
            pointer-events: none;
        }
        input.editable-val {
            background: var(--bg-input); border: 1px solid var(--border-input-focus); font-weight: bold;
        }
        input.editable-val:focus {
            background: var(--bg-input); box-shadow: 0 0 8px rgba(77, 166, 255, 0.6); outline: none; border-color: #80c4ff;
        }

        select { 
            padding: 5px; border-radius: 4px; border: 1px solid var(--btn-border); 
            background: var(--bg-input); color: var(--text-input); cursor: pointer; font-size: 0.9rem;
        }
        select.select-full { width: 100%; font-weight: bold; }
        
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; padding: 5px; width: 100%; }
        .settings-item { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; color: var(--text-sub); }
        
        .detail-stats {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
            border: 1px solid var(--btn-border);
        }
        .detail-stats h4 {
            grid-column: 1 / -1; margin: 8px 0 4px 0; font-size: 0.85rem; color: var(--accent-orange); 
            border-bottom: 1px solid var(--btn-border); padding-bottom: 2px;
            display: flex; justify-content: space-between;
        }
        .section-total { color: var(--text-main); font-weight: bold; }

        .stat-row { display: flex; flex-direction: column; gap: 3px; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); }
        .stat-inputs { display: flex; gap: 4px; align-items: center; }
        .stat-inputs input, .stat-inputs select { width: 100%; }
        .sub-label { font-size: 0.65rem; color: var(--text-muted); margin-right: 2px; width: 12px; text-align: center;}

        .calc-display { 
            grid-column: 1 / -1; 
            color: var(--text-sub); font-size: 0.8rem; text-align: right; 
            border-top: 1px solid var(--btn-border); margin-top: 5px; padding-top: 8px;
            display: flex; justify-content: space-between; flex-wrap: wrap; gap: 5px;
        }
        .calc-display span { color: var(--text-main); font-weight: bold; font-size: 1rem; }

        .toggle-group { display: flex; gap: 4px; flex-wrap: wrap; align-items: center;}
        button.toggle-btn {
            padding: 8px 10px; border: 1px solid var(--btn-border); background: var(--btn-bg);
            color: var(--btn-text); cursor: pointer; border-radius: 6px; font-size: 0.8rem;
            flex: 1; min-width: 50px; text-align: center;
            transition: 0.2s;
        }
        button.toggle-btn:hover { background: var(--btn-hover); }
        button.toggle-btn.active { color: #fff; font-weight: bold; border-color: transparent;}

        .orb-badge {
            padding: 6px 8px; border: 1px solid var(--btn-border); background: var(--btn-bg);
            color: var(--text-muted); border-radius: 6px; font-size: 0.75rem;
            flex: 1; min-width: 60px; text-align: center;
            pointer-events: none;
        }
        .orb-badge.active {
            border-color: var(--accent-green); color: var(--accent-green); background: rgba(0, 230, 118, 0.1); font-weight: bold;
        }

        button.toggle-btn.group-dmg.active { background: var(--accent-pink); box-shadow: 0 0 8px rgba(255, 42, 109, 0.4); }
        button.toggle-btn.group-mr.active { background: var(--accent-cyan); color: #000; box-shadow: 0 0 8px rgba(5, 217, 232, 0.4); }
        button.toggle-btn.group-taken.active { background: var(--accent-orange); color: #000; box-shadow: 0 0 8px rgba(255, 159, 28, 0.4); }
        button.toggle-btn.group-fb.active { background: #b5179e; box-shadow: 0 0 8px rgba(181, 23, 158, 0.4); }
        button.toggle-btn.group-down.active { background: #e0aaff; color: #240046; box-shadow: 0 0 8px rgba(224, 170, 255, 0.4); }
        
        button.toggle-btn.btn-baiki.active { background: var(--accent-pink); }
        button.toggle-btn[data-lukani="0.0"].active {
            background: linear-gradient(135deg, #ffd700, #ff8c00); 
            color: #000; box-shadow: 0 0 10px #ffd700;
        }
        button.toggle-btn[data-val="1.0"].group-dmg.active {
            background: #ff5e00; box-shadow: 0 0 10px #ff5e00;
        }
        button.toggle-btn.btn-force-norm { border: 1px dashed var(--accent-orange); color: var(--accent-orange); flex:none; width: auto;}
        button.toggle-btn.btn-force-norm.active { background: var(--accent-orange); color: #000; }
        
        button#btnCritBuff.active {
            background: #e91e63; color: white; box-shadow: 0 0 10px rgba(233, 30, 99, 0.5); border-color: transparent;
        }

        .resist-header { display: flex; justify-content: space-between; width: 100%; margin-bottom: 4px; }
        .resist-val { color: var(--accent-cyan); font-weight: bold; }

        .floating-wipe {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-panel);
            border: 2px solid var(--accent-pink);
            border-radius: 12px;
            padding: 8px 15px;
            text-align: right;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            min-width: 120px;
        }
        .floating-wipe.hidden { opacity: 0; transform: translateY(20px); }
        .wipe-label { font-size: 0.7rem; color: var(--text-sub); margin-bottom: -3px;}
        .wipe-value { font-size: 1.6rem; font-weight: bold; color: var(--text-main); font-family: "Consolas", monospace; }

        .separator { width: 100%; border-bottom: 1px dashed var(--btn-border); margin: 5px 0; }
    </style>
</head>
<body>

    <div class="header-area">
        <h1>DQX é˜²è¡›ç”¨ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—æ©Ÿ</h1>
        <button class="theme-toggle" onclick="toggleTheme()" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">ğŸŒ™</button>
    </div>

    <div id="floatingWipe" class="floating-wipe hidden">
        <div class="wipe-label">æœŸå¾…å€¤åˆè¨ˆ</div>
        <div class="wipe-value" id="wipeResult">0</div>
    </div>

    <div class="calculator-container">

        <div class="step-section">
            <div class="step-left">
                <div class="step-label">
                    <span class="step-icon">âš”ï¸</span> æ”»æ’ƒè¨­å®š & åŸºç¤ãƒ€ãƒ¡ãƒ¼ã‚¸
                </div>
                
                <div class="settings-grid">
                    <div class="settings-item">
                        <span>è·æ¥­</span>
                        <select id="calcJob" onchange="updateOptions()"></select>
                    </div>
                    <div class="settings-item">
                        <span>æ­¦å™¨ (ãƒ¡ã‚¤ãƒ³)</span>
                        <select id="calcWeapon" onchange="updateOptions()"></select>
                    </div>
                    <div class="settings-item">
                        <span>ç‰¹æŠ€</span>
                        <select id="calcSkillSelect" onchange="calcBaseDamage()"></select>
                    </div>
                    <div class="settings-item">
                        <span>ãƒã‚¤ã‚­ãƒ«ãƒˆ</span>
                        <button class="toggle-btn btn-baiki active" id="btnBaiki" onclick="toggleBaiki(this)">ON</button>
                    </div>
                    <div class="settings-item">
                        <span>æ•µå®ˆå‚™åŠ›</span>
                        <select id="calcBoss" onchange="onBossChange()">
                        </select>
                    </div>
                    
                    <div class="settings-item">
                        <span>ç‰¹æŠ€ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ– (160-180)</span>
                        <select id="skillAddDmg" onchange="calculate()">
                            <option value="0">ãªã—</option>
                            <option value="5">160 (+5)</option>
                            <option value="10">170 (+10)</option>
                            <option value="20" selected>180 (+20)</option>
                        </select>
                    </div>

                    <div class="settings-item" style="grid-column: 1 / -1;">
                        <span>ä¼šå¿ƒç‡(%) & è£œæ­£</span>
                        <div class="input-group" style="gap:5px; flex-wrap:nowrap;">
                            <input type="number" id="critRate" value="24" step="0.1" class="editable-val" style="width:70px;">
                            <button class="toggle-btn" id="btnCritBuff" onclick="toggleBtn(this)" style="flex:none; width:auto; padding:5px 15px; border-color:#e91e63; color:#ccc;">ä¼šå¿ƒç‡UP(+15%)</button>
                        </div>
                        <div id="critDisplay" style="font-size:0.75rem; color:#aaa; text-align:right; margin-top:2px;">å®Ÿè³ªè¨ˆç®—ç‡: 24.0%</div>
                    </div>
                    
                    <button class="detail-toggle-btn" onclick="toggleDetails()">ğŸ”½ æ”»æ’ƒåŠ›è©³ç´°è¨­å®š (åŸºç¤/éŒ¬é‡‘) ã‚’é–‹é–‰</button>

                    <div id="detailStats" class="detail-stats" style="display:none;">
                        
                        <div style="grid-column:1/-1;" class="legend">
                            <span class="l-fixed">å›ºå®šå€¤(ç·¨é›†ä¸å¯)</span>
                            <span class="l-edit">éŒ¬é‡‘/èª¿æ•´(å…¥åŠ›å¯)</span>
                        </div>

                        <h4>
                            ã¡ã‹ã‚‰è¨­å®š
                            <span class="section-total">åˆè¨ˆ: <span id="txt_str_total">0</span></span>
                        </h4>
                        <div class="stat-row">
                            <span class="stat-label">åŸºæœ¬ãƒ»ãƒ‘ãƒƒã‚·ãƒ–(è‡ªå‹•)</span>
                            <div class="stat-inputs"><input type="number" id="in_job_base" class="fixed-val" readonly><input type="number" id="in_job_passive" class="fixed-val" readonly></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">æ­¦ç¥/ç¦æ–­</span>
                            <div class="stat-inputs"><span class="sub-label">æ­¦</span><input type="number" id="in_bushin" value="6" class="editable-val"><span class="sub-label">ç¦</span><input type="number" id="in_kindan" value="6" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ã‚¿ãƒ/å¥³ç¥</span>
                            <div class="stat-inputs"><span class="sub-label">ç¨®</span><input type="number" id="in_seed" value="12" class="editable-val"><span class="sub-label">æœ¨</span><input type="number" id="in_wood" value="33" class="editable-val"></div>
                        </div>

                        <h4>
                            è£…å‚™è¨­å®š (æ­¦å™¨+ã‚¢ã‚¯ã‚»)
                            <span class="section-total">åˆè¨ˆ: <span id="txt_equip_total">0</span></span>
                        </h4>
                        <div class="stat-row">
                            <span class="stat-label">æ­¦å™¨å³æ‰‹</span>
                            <div class="stat-inputs"><input type="number" id="in_wepR_base" class="fixed-val" readonly><input type="number" id="in_wepR_alch" value="0" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">æ­¦å™¨å·¦æ‰‹</span>
                            <div class="stat-inputs"><input type="number" id="in_wepL_base" class="fixed-val" readonly><input type="number" id="in_wepL_alch" value="0" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">é¡”(ãƒ‡ã‚¹ãƒã‚¹ã‚¯)</span>
                            <div class="stat-inputs"><input type="number" value="0" class="fixed-val" readonly><input type="number" value="0" class="fixed-val" disabled style="opacity:0.5;"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">é¦–(ãƒãƒ§ãƒ¼ã‚«ãƒ¼)</span>
                            <div class="stat-inputs"><input type="number" id="in_neck_base" value="30" class="fixed-val" readonly><input type="number" id="in_neck_alch" value="40" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">æŒ‡(æ–­ç½ª)</span>
                            <div class="stat-inputs"><input type="number" id="in_finger_base" value="0" class="fixed-val" readonly><input type="number" id="in_finger_alch" value="6" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">èƒ¸(ã‚»ãƒˆ)</span>
                            <div class="stat-inputs"><input type="number" id="in_chest_base" value="7" class="fixed-val" readonly><input type="number" id="in_chest_alch" value="12" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">è…°(æˆ¦ç¥/è¼çŸ³)</span>
                            <div class="stat-inputs"><input type="number" id="in_belt_base" value="0" class="fixed-val" readonly><input type="number" id="in_belt_alch" value="25" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">æœ­(ä¸æ€è­°)</span>
                            <div class="stat-inputs"><input type="number" id="in_card_base" value="0" class="fixed-val" readonly><input type="number" id="in_card_alch" value="15" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ä»–(ãƒ‘ãƒ¯ãƒãƒ£)</span>
                            <div class="stat-inputs"><input type="number" id="in_other_base" value="5" class="fixed-val" readonly><input type="number" id="in_other_alch" value="9" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ç´‹ç« (ãƒãƒ«ãƒ•ã‚¡ã‚¹)</span>
                            <div class="stat-inputs"><input type="number" id="in_emblem_base" value="5" class="fixed-val" readonly><input type="number" id="in_emblem_alch" value="20" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">è¨¼(å¤¢å¹»/é‚ªæ•™)</span>
                            <div class="stat-inputs"><input type="number" id="in_badge_base" value="5" class="fixed-val" readonly><input type="number" id="in_badge_alch" value="0" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ã“ã“ã‚</span>
                            <div class="stat-inputs">
                                <select id="in_heart_select" onchange="calcBaseDamage()" style="width:100%; font-size:0.75rem;">
                                    <option value="6">ã‚¬ãƒŠã‚µãƒ€ã‚¤(6)</option>
                                    <option value="12">ã‚«ãƒ–(12)</option>
                                    <option value="7">ãƒ¦ã‚·ãƒ¥ã‚«(7)</option>
                                    <option value="15">ãƒ´ã‚¡ãƒ¬ãƒªã‚¢(15)</option>
                                </select>
                                <input type="number" id="in_heart_alch" value="0" class="editable-val">
                            </div>
                        </div>

                        <h4>ãã®ä»–è£œæ­£</h4>
                        <div class="stat-row">
                            <span class="stat-label">ã‚»ãƒƒãƒˆåŠ¹æœ</span>
                            <select id="in_set_select" onchange="updateSetEffect()">
                                <option value="13">ãƒˆãƒ©ã‚¤ãƒ‰ (+13)</option>
                                <option value="11">ä¸€è§’ (+11)</option>
                                <option value="8">è–åŸŸ (+8)</option>
                                <option value="0">ãªã—</option>
                            </select>
                            <input type="hidden" id="in_set_alch" value="13">
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ã‚¹ã‚­ãƒ«(0-150)</span>
                            <div class="stat-inputs"><span class="sub-label">éŒ¬</span><input type="number" id="in_skill_150" value="0" class="editable-val"></div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ã‚¹ã‚­ãƒ«(160-200)</span>
                            <div class="stat-inputs"><span class="sub-label">éŒ¬</span><input type="number" id="in_skill_alch" value="0" class="editable-val"></div>
                        </div>
                    </div>

                    <div class="settings-item" style="grid-column: 1 / -1;">
                        <span>ãƒ«ã‚«ãƒ‹ / ã‚¢ãƒŒãƒ“ã‚¹</span>
                        <div class="toggle-group">
                            <button class="toggle-btn active" data-lukani="1.0" onclick="setLukani(this)">ãªã—</button>
                            <button class="toggle-btn" data-lukani="0.7" onclick="setLukani(this)">1æ®µ</button>
                            <button class="toggle-btn" data-lukani="0.6" onclick="setLukani(this)">2æ®µ</button>
                            <button class="toggle-btn" data-lukani="0.0" onclick="setLukani(this)" style="font-weight:bold;">ã‚¢ãƒŒãƒ“ã‚¹</button>
                        </div>
                    </div>
                    
                    <div class="calc-display">
                        <div>è¡¨ç¤ºæ”»æ’ƒåŠ›: <span id="displayAtkR">0</span> (å·¦:<span id="displayAtkL">0</span>)</div>
                        <div>æ•µå®ˆå‚™åŠ›: <span id="displayDef">760</span></div>
                        <input type="hidden" id="baseDmg" value="0">
                    </div>
                </div>
            </div>
            
            <div class="step-result" id="res-base" style="align-self: flex-end; margin-bottom: 5px;">
                <span id="baseValDisplay">0</span>
                <small>START</small>
            </div>
        </div>

        <div class="beam-connector" id="beam1"></div>

        <div class="step-section">
            <div class="step-left">
                <div class="step-label"><span class="step-icon">ğŸ”¥</span> å±æ€§ãƒ€ãƒ¡ãƒ¼ã‚¸</div>
                <div class="input-group">
                    <div class="input-item">
                        <span>ãƒ™ãƒ«ãƒˆ</span>
                        <select id="attrBelt">
                            <option value="0">ãªã—</option>
                            <option value="0.15" selected>15%</option>
                            <option value="0.14">14%</option>
                            <option value="0.13">13%</option>
                            <option value="0.12">12%</option>
                            <option value="0.11">11%</option>
                            <option value="0.10">10%</option>
                            <option value="0.09">9%</option>
                            <option value="0.08">8%</option>
                            <option value="0.07">7%</option>
                            <option value="0.06">6%</option>
                            <option value="0.05">5%</option>
                            <option value="0.04">4%</option>
                        </select>
                    </div>
                    <div class="input-item">
                        <span>æ–­ç½ª</span>
                        <select id="attrRing">
                            <option value="0">ãªã—</option>
                            <option value="0.05" selected>5%</option>
                            <option value="0.04">4%</option>
                            <option value="0.03">3%</option>
                            <option value="0.025">2.5%</option>
                            <option value="0.02">2%</option>
                        </select>
                    </div>
                    <div class="input-item">
                        <span>ã“ã“ã‚</span>
                        <select id="attrHeart">
                            <option value="0">ãªã—</option>
                            <option value="0.03" selected>3%</option>
                            <option value="0.02">2%</option>
                            <option value="0.01">1%</option>
                        </select>
                    </div>
                    <div class="input-item">
                        <span>æ­¦å™¨åŸºç¤</span>
                        <select id="attrWepBase">
                            <option value="0">0%</option>
                            <option value="0.01">1%</option>
                            <option value="0.02">2%</option>
                            <option value="0.03">3%</option>
                            <option value="0.04">4%</option>
                            <option value="0.05">5%</option>
                            <option value="0.06">6%</option>
                            <option value="0.07">7%</option>
                            <option value="0.08">8%</option>
                            <option value="0.09">9%</option>
                            <option value="0.10">10%</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="step-result" id="res-attr">1000<small>Ã—å±æ€§</small></div>
        </div>

        <div class="beam-connector" id="beam2"></div>

        <div class="step-section">
            <div class="step-left">
                <div class="step-label"><span class="step-icon">ğŸ“¢</span> ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸UP (ç¨®æ—ãƒ»å¼·åŒ–ãƒ»å®ç )</div>
                
                <div class="input-group">
                    <div class="input-item">
                        <span>ãƒ™ãƒ«ãƒˆ</span>
                        <select id="raceBelt">
                            <option value="0">ãªã—</option>
                            <option value="0.12" selected>12%</option>
                            <option value="0.11">11%</option>
                            <option value="0.10">10%</option>
                            <option value="0.09">9%</option>
                            <option value="0.08">8%</option>
                            <option value="0.07">7%</option>
                            <option value="0.06">6%</option>
                            <option value="0.05">5%</option>
                            <option value="0.04">4%</option>
                        </select>
                    </div>
                    <div class="input-item">
                        <span>æ–­ç½ª</span>
                        <select id="raceRing">
                            <option value="0">ãªã—</option>
                            <option value="0.11" selected>11%</option>
                            <option value="0.09">9%</option>
                            <option value="0.07">7%</option>
                            <option value="0.05">5%</option>
                            <option value="0.03">3%</option>
                        </select>
                    </div>
                    <div class="input-item">
                        <span>æ­¦å™¨åŸºç¤</span>
                        <select id="raceWepBase">
                            <option value="0">0%</option>
                            <option value="0.01">1%</option>
                            <option value="0.02">2%</option>
                            <option value="0.03">3%</option>
                            <option value="0.04">4%</option>
                            <option value="0.05">5%</option>
                            <option value="0.06">6%</option>
                            <option value="0.07">7%</option>
                            <option value="0.08">8%</option>
                            <option value="0.09">9%</option>
                            <option value="0.10">10%</option>
                        </select>
                    </div>
                    
                    <div class="input-item">
                        <span>éšç´š</span>
                        <select id="classBonus">
                            <option value="0">ãªã—</option>
                            <option value="0.04" selected>èµ¤è‚©(4%)</option>
                            <option value="0.03">é’è‚©(3%)</option>
                            <option value="0.02">ç·‘è‚©(2%)</option>
                            <option value="0.01">ç°è‚©(1%)</option>
                        </select>
                    </div>

                    <div class="input-item" style="margin-left:5px;">
                        <span>&nbsp;</span>
                        <button class="toggle-btn btn-force-norm" id="btnForceNorm" onclick="toggleBtn(this)">Fé€šå¸¸(+10%)</button>
                    </div>
                </div>

                <div class="separator"></div>

                <div class="toggle-group">
                    <button class="toggle-btn group-dmg" data-val="0.5" onclick="toggleBtn(this)">çŒ›æ”»ã®æ›¸</button>
                    <button class="toggle-btn group-dmg" id="btnGadget" data-val="1.0" onclick="toggleBtn(this)">ã‚¬ã‚¸ã‚§ãƒƒãƒˆ</button>
                    <button class="toggle-btn group-mr" data-val="0.5" data-exclusive="mr" onclick="toggleBtn(this)">MR(å¤§)</button>
                    <button class="toggle-btn group-mr" data-val="0.2" data-exclusive="mr" onclick="toggleBtn(this)">MR(å°)</button>
                    
                    <div id="orbBadge" class="orb-badge">ğŸ’å®ç  0%</div>
                </div>

            </div>
            <div class="step-result" id="res-merged">1000<small>Ã—å…¨åŠ ç®—æ </small></div>
        </div>

        <div class="beam-connector" id="beam3"></div>

        <div class="step-section">
            <div class="step-left">
                <div class="step-label"><span class="step-icon">ğŸªƒ</span> æ•µã®è¢«ãƒ€ãƒ¡UP</div>
                <div class="step-controls toggle-group">
                    <button class="toggle-btn group-taken" data-val="0.5" onclick="toggleBtn(this)">ãƒ¬ãƒœãƒ«ç³»</button>
                    <button class="toggle-btn group-taken" data-val="0.5" onclick="toggleBtn(this)">ç½ç¦ã®é™£</button>
                </div>
            </div>
            <div class="step-result" id="res-taken">1000<small>Ã—å¼±ä½“</small></div>
        </div>

        <div class="beam-connector" id="beam4"></div>

        <div class="step-section">
            <div class="step-left">
                <div class="step-label"><span class="step-icon">ğŸ›¡ï¸</span> æ•µã®å±æ€§è€æ€§ä½ä¸‹</div> 
                    <div class="input-item item-full">
                        <div class="resist-header">
                            <span>æ”»æ’ƒå±æ€§ (ãƒœã‚¹ã®è€æ€§)</span>
                        </div>
                        <select id="attackElement" class="select-full" onchange="calculate()">
                            <option value="fire">ç‚å±æ€§</option>
                            <option value="ice">æ°·å±æ€§</option>
                            <option value="wind">é¢¨å±æ€§</option>
                            <option value="thunder">é›·å±æ€§</option>
                            <option value="earth">åœŸå±æ€§</option>
                            <option value="light" selected>å…‰å±æ€§</option>
                            <option value="dark">é—‡å±æ€§</option>
                        </select>
                    </div>
                <div class="step-controls toggle-group">
                    <button class="toggle-btn group-fb" data-val="1.0" data-exclusive="fb" onclick="toggleBtn(this)">FB(å¤§)</button>
                    <button class="toggle-btn group-fb" data-val="0.5" data-exclusive="fb" onclick="toggleBtn(this)">FB(å°)</button>
                    
                    <button class="toggle-btn group-down" data-val="0.5" data-exclusive="down" onclick="toggleBtn(this)">ä½ä¸‹50%</button>
                    <button class="toggle-btn group-down" data-val="0.3" data-exclusive="down" onclick="toggleBtn(this)">ä½ä¸‹30%</button>
                </div>
            </div>
            <div class="step-result" id="res-fb">1000<small>Ã—è€æ€§</small></div>
        </div>

        <div class="beam-connector" id="beam5"></div>

        <div class="result-panel">
            <div class="total-multiplier" id="totalMult">x 1.00 å€</div>
            
            <div class="final-label">æœŸå¾…å€¤ (åˆè¨ˆ)</div>
            <div class="final-damage" id="finalResult">0</div>
            
            <div class="expected-val" id="wipeResult" style="display:none;"></div> 

            <button class="detail-toggle-btn" onclick="toggleRandomDetail()">ğŸ“Š è©³ç´°: 1ç™ºã”ã¨ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ (Min ~ Max) ã‚’è¡¨ç¤º</button>
            <div id="randomDetail" class="hit-detail-box"></div>

            <div class="compare-tools">
                <button class="btn-snapshot" onclick="saveSnapshot()">ğŸ“· æ¯”è¼ƒç”¨ã«çŠ¶æ…‹ã‚’ã‚­ãƒ¼ãƒ—</button>
                <div class="diff-display" id="diffDisplay">
                    åŸºæº–(æœŸå¾…å€¤): <span id="snapshotVal">0</span> 
                    <span id="diffVal" style="margin-left:10px;">Â±0</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        const MAX_WIDTH_PX = 300;
        const BASE_WIDTH_PX = 12;
        let snapshotDamage = null; 
        let lukaniRate = 1.0; 
        
        let currentHitBases = []; 
        let currentHitMinBases = []; 
        let currentHitMaxBases = []; 
        
        let currentHitCritBases = []; 
        let currentHitCritMinBases = []; 
        let currentHitCritMaxBases = []; 
        
        let currentHitCritMults = [];
        let currentHitIsLeft = []; 
        let currentHitCritTypes = []; 
        let currentHitCritInfo = []; 

        //ã€€ãƒœã‚¹è¨­å®š
        const bosses = {
            'yanubi': { 
                name: 'ãƒ¤ãƒŒãƒ“', 
                def: 760, 
                resist: { fire: 1.00, ice: 1.00, wind: 1.00, thunder: 1.00, earth: 1.00, light: 1.00, dark: 1.00 }
            },
            'baora': { 
                name: 'ãƒã‚ªãƒ©', 
                def: 830, 
                resist: { fire: 0.90, ice: 1.10, wind: 0.90, thunder: 1.00, earth: 1.00, light: 1.00, dark: 1.00 }
            }
        };

        // å±æ€§åã®æ—¥æœ¬èªå®šç¾©
        const attrNames = {
            'fire': 'ç‚å±æ€§',
            'ice': 'æ°·å±æ€§',
            'wind': 'é¢¨å±æ€§',
            'thunder': 'é›·å±æ€§',
            'earth': 'åœŸå±æ€§',
            'light': 'å…‰å±æ€§',
            'dark': 'é—‡å±æ€§'
        };

        const jobs = {
            'bato': { name: 'ãƒãƒˆãƒã‚¹', base: 419, passive: 90, types: ['sword'] },
            'masen': { name: 'é­”æ³•æˆ¦å£«', base: 317, passive: 80, types: ['bow', 'sword'] },
            'ranger': { name: 'ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼', base: 311, passive: 80, types: ['claw', 'boomerang', 'bow'] },
            'dougu': { name: 'ã©ã†ãä½¿ã„', base: 313, passive: 80, types: ['spear', 'bow'] },
            'gad': { name: 'ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³', base: 342, passive: 100, types: ['spear', 'sword'] },
            'odori': { name: 'è¸Šã‚Šå­', base: 324, passive: 100, types: ['fan'] }
        };

        const weapons = {
            'shugoryu': { name: 'å®ˆè­·ç«œã®ã¤ã‚‹ã', atk: 284, type: 'sword' },
            'hayabusa': { name: 'ã¯ã‚„ã¶ã•ã®å‰£æ”¹', atk: 129, type: 'sword' },
            'jusei': { name: 'å‘ªæ˜Ÿã®ãƒ„ãƒ¡', atk: 180, type: 'claw' },
            'nymph': { name: 'ãƒ‹ãƒ³ãƒ•ã®å¦–å¼“', atk: 325, type: 'bow' },
            'papilsag': { name: 'ãƒ‘ãƒ”ãƒ«ã‚µã‚°ã®å¼“', atk: 295, type: 'bow', attrVal: 0.05 },
            'furumu': { name: 'ãƒ•ãƒ«ãƒ ã®å¼“', atk: 315, type: 'bow', attrVal: 0.03 },
            'meigunshi': { name: 'åè»å¸«ã®ç¾½æ‰‡', atk: 253, type: 'fan' },
            'spear': { name: 'ãƒŸã‚«ãƒ…ãƒã®æ§', atk: 358, type: 'spear' },
            'sailas': { name: 'ã‚»ãƒ¼ãƒ©ã‚¹ã‚¨ãƒƒã‚¸', atk: 210, type: 'boomerang' }
        };

        const skills = {
            'normal': { name: 'é€šå¸¸æ”»æ’ƒ', type: 'weapon', mult: 1.0, hits: 1, orb: 0, crit: 1.0, cap: 9999, isNormal: true },
            'bato_norm': { name: 'ãƒãƒˆé€šå¸¸(äºŒåˆ€)', hits: [{m:1.0, t:'R'}, {m:1.0, t:'L'}], orb:0, crit: 1.0, cap: 9999, isNormal: true },
            'haya_norm': { name: 'éš¼/ãƒ„ãƒ¡é€šå¸¸', hits: [{m:1.0, t:'R'}, {m:0.7, t:'R'}], orb:0, crit: 1.0, cap: 9999, isNormal: true },
            'haya_bato_norm': { name: 'éš¼ãƒãƒˆé€šå¸¸', hits: [{m:1.0, t:'R'}, {m:0.7, t:'R'}, {m:1.0, t:'L'}, {m:0.7, t:'L'}], orb:0, crit: 1.0, cap: 9999, isNormal: true },
            
            // Bato Job Skills
            'tenka': { name: 'å¤©ä¸‹ç„¡åŒ', type: 'weapon', mult: 0.9, hits: 6, orb: 18, crit: 0.3, cap: 1999, batoLeft: true }, 
            'kokon': { name: 'å¤ä»Šç„¡åŒ', type: 'weapon', mult: 1.75, hits: 4, orb: 6, crit: 1.0, cap: 9999, batoLeft: true },
            'rush': { name: 'ãƒ©ãƒƒã‚·ãƒ¥ãƒãƒ¼ãƒ³', type: 'weapon', mult: 4.7, hits: 4, orb: 12, crit: 1.0, cap: 9999, batoLeft: true },

            // Masen Job Skills
            'madante': { name: 'ãƒãƒ€ãƒ³ãƒ†', type: 'fixed', val: 4200, hits: 1, orb: 6, crit: 0, cap: 19999 },
            'energy': { name: 'ã‚¨ãƒŠã‚¸ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«', type: 'fixed', val: 7000, hits: 1, orb: 12, crit: 0, cap: 29999 },

            // Ranger Job Skills
            'anubis': { name: 'ã‚¢ãƒŒãƒ“ã‚¹ã‚¢ã‚¿ãƒƒã‚¯', type: 'fixed', val: 1500, hits: 3, width: 25, orb: 12, crit: 0, cap: 9999 },
            
            // Gad Job Skills
            'prana': { name: 'ãƒ—ãƒ©ãƒ¼ãƒŠã‚½ãƒ¼ãƒ‰', type: 'weapon', mult: 1.1, hits: 6, orb: 12, crit: 0.25, cap: 9999 },
            'divine': { name: 'ãƒ‡ã‚£ãƒã‚¤ãƒ³ãƒ”ãƒ«ãƒ ', type: 'fixed', val: 3000, hits: 1, orb: 12, crit: 0, cap: 9999 },

            // Sword
            'fushicho': { name: 'ä¸æ­»é³¥å¤©èˆ', type: 'weapon', mult: 0.9, hits: 4, orb: 30, crit: 1.0, cap: 9999 },
            'chohaya': { name: 'è¶…ã¯ã‚„ã¶ã•æ–¬ã‚Š', type: 'weapon', mult: 0.75, hits: 4, orb: 36, crit: 1.1, cap: 9999 },
            'ultima': { name: 'ã‚¢ãƒ«ãƒ†ãƒã‚½ãƒ¼ãƒ‰', type: 'weapon', mult: 4.8, hits: 1, orb: 12, crit: 1.0, cap: 9999 },
            'gigabreak': { name: 'ã‚®ã‚¬ãƒ–ãƒ¬ã‚¤ã‚¯', type: 'fixed', val: 1500, hits: 1, width: 20, orb: 30, crit: 0.25, cap: 9999 },

            // Bow
            'darkness': { name: 'ãƒ€ãƒ¼ã‚¯ãƒã‚¹ã‚·ãƒ§ãƒƒãƒˆ', type: 'weapon', mult: 3.8, add: 10, hits: 1, orb: 18, crit: 0.5, cap: 9999 },
            'shining': { name: 'ã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°ãƒœã‚¦', type: 'weapon', mult: 0.75, hits: 4, orb: 12, crit: 0.25, cap: 9999 },
            'sunlight': { name: 'ã‚µãƒ³ãƒ©ã‚¤ãƒˆã‚¢ãƒ­ãƒ¼', type: 'weapon', mult: 0.95, hits: 4, orb: 12, crit: 0.25, cap: 9999 },
            'lostsnipe': { name: 'ãƒ­ã‚¹ãƒˆã‚¹ãƒŠã‚¤ãƒ—', type: 'weapon', mult: 2.0, hits: 1, orb: 30, crit: 0.5, cap: 9999 },
            'samidareuchi': { name: 'ã•ã¿ã ã‚Œã†ã¡', type: 'weapon', mult: 0.65, hits: 4, orb: 30, crit: 0.25, cap: 1999 },

            // Boomerang
            'dualbreaker': { name: 'ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼', type: 'weapon', mult: 2.4, hits: 2, orb: 18, crit: 0.25, cap: 9999 },
            'frozen': { name: 'ãƒ•ãƒ­ãƒ¼ã‚ºãƒ³ã‚¹ãƒ¯ãƒ­ãƒ¼', type: 'weapon', mult: 0.8, hits: 7, orb: 12, crit: 1.0, cap: 9999 },
            'gigashoot': { name: 'ã‚®ã‚¬ã‚·ãƒ¥ãƒ¼ãƒˆ', type: 'weapon', mult: 4.5, hits: 2, orb: 12, crit: 1.0, cap: 9999 },
            'gigathrow': { name: 'ã‚®ã‚¬ã‚¹ãƒ­ãƒ¼', type: 'weapon', mult: 3.0, hits: 2, orb: 12, crit: 1.0, cap: 9999 },
            'revol': { name: 'ãƒ¬ãƒœãƒ«ã‚¹ãƒ©ã‚¤ã‚µãƒ¼', type: 'weapon', mult: 5.0, hits: 1, orb: 18, crit: 0.5, cap: 9999 },

            // Claw
            'liger': { name: 'ãƒ©ã‚¤ã‚¬ãƒ¼ã‚¯ãƒ©ãƒƒã‚·ãƒ¥', type: 'weapon', mult: 2.5, hits: 5, orb: 6, crit: 0.25, cap: 9999 },
            'tiger': { name: 'ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¯ãƒ­ãƒ¼', type: 'weapon', mult: 1.3, hits: 3, orb: 18, crit: 0.25, cap: 1999 },
            'godsmash': { name: 'ã‚´ãƒƒãƒ‰ã‚¹ãƒãƒƒã‚·ãƒ¥', type: 'fixed', val: 4400, hits: 1, width: 15, orb: 12, crit: 0.25, cap: 9999 },

            // Spear
            'samidare': { name: 'ã•ã¿ã ã‚Œçªã', type: 'weapon', mult: 0.9, add: 10, hits: 4, orb: 24, crit: 0.25, cap: 9999 },
            'cho_samidare': { name: 'è¶…ã•ã¿ã ã‚Œçªã', type: 'weapon', mult: 1.2, hits: 5, orb: 12, crit: 0.5, cap: 9999 }, 
            'bushin': { name: 'æ­¦ç¥ã®è­·æ³•', type: 'weapon', mult: 2.5, hits: 1, orb: 30, crit: 0.5, cap: 9999 },
            'jigo': { name: 'ã‚¸ã‚´ã‚¹ãƒ‘ãƒ¼ã‚¯', type: 'fixed', val: 600, hits: 1, width: 30, orb: 30, crit: 0.25, cap: 9999 },

            // Fan (Odori)
            'ougi_ranbu': { name: 'ãŠã†ãä¹±èˆ', type: 'weapon', mult: 0.8, hits: 6, orb: 12, crit: 0.5, cap: 9999 }
        };

        const inputs = {
            base: document.getElementById('baseDmg'),
            baseValDisplay: document.getElementById('baseValDisplay'),
            
            attrBelt: document.getElementById('attrBelt'),
            attrRing: document.getElementById('attrRing'),
            attrHeart: document.getElementById('attrHeart'),
            attrWepBase: document.getElementById('attrWepBase'),
            
            raceBelt: document.getElementById('raceBelt'),
            raceRing: document.getElementById('raceRing'),
            raceWepBase: document.getElementById('raceWepBase'),
            classBonus: document.getElementById('classBonus'), 
            btnForceNorm: document.getElementById('btnForceNorm'),
            calcJob: document.getElementById('calcJob'),
            calcWeapon: document.getElementById('calcWeapon'),
            calcSkillSelect: document.getElementById('calcSkillSelect'),
            btnBaiki: document.getElementById('btnBaiki'),
            calcBoss: document.getElementById('calcBoss'),
            critRate: document.getElementById('critRate'),
            btnCritBuff: document.getElementById('btnCritBuff'),
            skillAddDmg: document.getElementById('skillAddDmg'), // New
            
            displayAtkR: document.getElementById('displayAtkR'),
            displayAtkL: document.getElementById('displayAtkL'),
            displayDef: document.getElementById('displayDef'),
            txtStrTotal: document.getElementById('txt_str_total'),
            txtEquipTotal: document.getElementById('txt_equip_total'),

            // Details
            in_job_base: document.getElementById('in_job_base'),
            in_job_passive: document.getElementById('in_job_passive'),
            in_bushin: document.getElementById('in_bushin'),
            in_kindan: document.getElementById('in_kindan'),
            in_seed: document.getElementById('in_seed'),
            in_wood: document.getElementById('in_wood'),
            
            in_wepR_base: document.getElementById('in_wepR_base'),
            in_wepR_alch: document.getElementById('in_wepR_alch'),
            in_wepL_base: document.getElementById('in_wepL_base'),
            in_wepL_alch: document.getElementById('in_wepL_alch'),

            // Accessories
            in_heart_select: document.getElementById('in_heart_select'),
            in_set_alch: document.getElementById('in_set_alch'),
            in_skill_alch: document.getElementById('in_skill_alch'),
            in_skill_150: document.getElementById('in_skill_150')
        };

        const resultLabels = [
            null, 
            document.getElementById('res-attr'),
            document.getElementById('res-merged'),
            document.getElementById('res-taken'),
            document.getElementById('res-fb')
        ];

        const beams = [
            document.getElementById('beam1'),
            document.getElementById('beam2'),
            document.getElementById('beam3'),
            document.getElementById('beam4'),
            document.getElementById('beam5')
        ];

        function init() {
            inputs.calcJob.innerHTML = '';
            for(let key in jobs) {
                let opt = document.createElement('option');
                opt.value = key;
                opt.text = jobs[key].name;
                inputs.calcJob.appendChild(opt);
            }

            // ãƒœã‚¹é¸æŠè‚¢ã®ç”Ÿæˆ
            inputs.calcBoss.innerHTML = '';
            for(let key in bosses) {
                let b = bosses[key];
                let opt = document.createElement('option');
                opt.value = key;
                // è¡¨ç¤ºåã«å®ˆå‚™åŠ›ã‚’å«ã‚ã‚‹
                opt.text = `${b.name} (å®ˆ${b.def})`;
                inputs.calcBoss.appendChild(opt);
            }

            updateOptions();
            setupObserver();
            onBossChange();
        }

        // ãƒœã‚¹å¤‰æ›´æ™‚ã®å‡¦ç†ã¾ã¨ã‚
        function onBossChange() {
            updateResistOptions(); // å±æ€§ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
            calcBaseDamage();      // ãƒ€ãƒ¡ãƒ¼ã‚¸å†è¨ˆç®—
        }

        // å±æ€§ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateResistOptions() {
            const bossKey = document.getElementById('calcBoss').value;
            const boss = bosses[bossKey];
            const select = document.getElementById('attackElement');
            
            if (!boss) return;

            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å†…ã®å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›¸ãæ›ãˆ
            Array.from(select.options).forEach(opt => {
                const type = opt.value; // fire, ice, ...
                const val = boss.resist[type];
                
                // å®šç¾©ãŒã‚ã‚Œã°ã€Œå±æ€§å æ•°å€¤å€ã€ã®å½¢å¼ã«ã™ã‚‹
                if (val !== undefined && attrNames[type]) {
                    opt.text = `${attrNames[type]} ${val.toFixed(2)}å€`;
                }
            });
        }

        function setupObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const wipe = document.getElementById('floatingWipe');
                    if (entry.isIntersecting) {
                        wipe.classList.add('hidden');
                    } else {
                        wipe.classList.remove('hidden');
                    }
                });
            }, { threshold: 0.1 });
            observer.observe(document.querySelector('.result-panel'));
        }

        function toggleDetails() {
            const el = document.getElementById('detailStats');
            el.style.display = (el.style.display === 'none') ? 'grid' : 'none';
        }

        function toggleRandomDetail() {
            const el = document.getElementById('randomDetail');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        function updateSetEffect() {
            const val = document.getElementById('in_set_select').value;
            document.getElementById('in_set_alch').value = val;
            calcBaseDamage();
        }

        function updateOptions() {
            const jobKey = inputs.calcJob.value;
            const currentWep = inputs.calcWeapon.value;
            
            // Set Job Base/Passive to inputs
            inputs.in_job_base.value = jobs[jobKey].base;
            inputs.in_job_passive.value = jobs[jobKey].passive;

            // æ­¦å™¨ç¨®(types)ã«ä¸€è‡´ã™ã‚‹æ­¦å™¨ã‚’å…¨æ­¦å™¨ã‹ã‚‰æŠ½å‡ºã—ã¦ãƒªã‚¹ãƒˆåŒ–
            inputs.calcWeapon.innerHTML = '';
            const allowedTypes = jobs[jobKey].types || [];

            // weaponsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®å…¨æ­¦å™¨ã‚’èµ°æŸ»
            for (let wKey in weapons) {
                let w = weapons[wKey];
                // ãã®æ­¦å™¨ã®typeãŒã€ç¾åœ¨ã®è·æ¥­ã®è¨±å¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
                if (allowedTypes.includes(w.type)) {
                    let opt = document.createElement('option');
                    opt.value = wKey;
                    opt.text = `${w.name} (æ”»${w.atk})`;
                    inputs.calcWeapon.appendChild(opt);
                }
            }

            // ä»¥å‰é¸æŠã—ã¦ã„ãŸæ­¦å™¨ãŒæ–°ã—ã„ãƒªã‚¹ãƒˆã«ã‚‚ã‚ã‚Œã°ç¶­æŒã€ãªã‘ã‚Œã°å…ˆé ­ã‚’é¸æŠ
            if (weapons[currentWep] && allowedTypes.includes(weapons[currentWep].type)) {
                inputs.calcWeapon.value = currentWep;
            }
            
            const wData = weapons[inputs.calcWeapon.value];
            if(wData) {
                inputs.in_wepR_base.value = wData.atk;
                inputs.in_wepL_base.value = wData.atk; 
            }
            
            // Auto Set Skill 150
            const wepType = (wData) ? wData.type : 'sword'; // å®‰å…¨ç­–
            let s150 = 0;
            if(wepType === 'sword') s150 = 40;
            else if(wepType === 'bow') s150 = 40;
            else if(wepType === 'claw') s150 = 75;
            else if(wepType === 'spear') s150 = 55;
            else if(wepType === 'fan') s150 = 50;
            document.getElementById('in_skill_150').value = s150;

            // Auto Set Weapon Attr Base
            let attrBaseVal = 0;
            if (wData && wData.attrVal) {
                attrBaseVal = wData.attrVal;
            }
            inputs.attrWepBase.value = attrBaseVal.toFixed(2).replace(/\.?0+$/, "");
            if(inputs.attrWepBase.value === "") inputs.attrWepBase.value = "0"; 

            updateSkillOptions();
            calcBaseDamage();
        }

        function updateSkillOptions() {
            const jobKey = inputs.calcJob.value;
            const wepKey = inputs.calcWeapon.value;
            if(!weapons[wepKey]) return;
            const wepType = weapons[wepKey].type;
            
            inputs.calcSkillSelect.innerHTML = '';
            let availSkills = ['normal'];

            // Bato logic
            if (jobKey === 'bato') {
                if (wepKey === 'hayabusa') availSkills.push('haya_bato_norm');
                else availSkills.push('bato_norm');
                availSkills.push('tenka', 'kokon', 'rush');
            }
            else if (wepKey === 'hayabusa') availSkills.push('haya_norm');

            // Masen
            if(jobKey === 'masen') {
                availSkills.push('madante', 'energy');
            }
            // Ranger
            if(jobKey === 'ranger') {
                availSkills.push('anubis');
            }
            // Gad
            if(jobKey === 'gad') {
                availSkills.push('prana', 'divine');
            }

            // Weapon Skills
            if (wepType === 'sword') {
                availSkills.push('fushicho', 'chohaya', 'ultima', 'gigabreak');
            } else if (wepType === 'bow') {
                availSkills.push('darkness', 'shining', 'sunlight', 'lostsnipe', 'samidareuchi');
            } else if (wepType === 'boomerang') {
                availSkills.push('dualbreaker', 'frozen', 'gigashoot', 'gigathrow', 'revol');
            } else if (wepType === 'claw') {
                availSkills.push('liger', 'tiger', 'godsmash');
            } else if (wepType === 'spear') {
                availSkills.push('samidare', 'cho_samidare', 'bushin', 'jigo');
            } else if (wepType === 'fan') {
                availSkills.push('ougi_ranbu');
            }
            
            availSkills.forEach(sKey => {
                if (skills[sKey]) {
                    let opt = document.createElement('option');
                    opt.value = sKey;
                    opt.text = skills[sKey].name;
                    inputs.calcSkillSelect.appendChild(opt);
                }
            });
        }

        function getNum(id) {
            let el = document.getElementById(id);
            return el ? (parseFloat(el.value) || 0) : 0;
        }

        function calcBaseDamage() {
            const sKey = inputs.calcSkillSelect.value;
            const skillData = skills[sKey];

            // åŸºç¤æ”»æ’ƒåŠ› (Base) ã®åˆè¨ˆã‚’ç®—å‡º
            // ã‚°ãƒ«ãƒ¼ãƒ—1: ã¡ã‹ã‚‰
            let totalStrBase = 0; 
            totalStrBase += getNum('in_job_base');
            totalStrBase += getNum('in_job_passive');
            totalStrBase += getNum('in_bushin');
            totalStrBase += getNum('in_kindan');
            totalStrBase += getNum('in_seed');
            totalStrBase += getNum('in_wood');
            
            // ã‚°ãƒ«ãƒ¼ãƒ—2: è£…å‚™(ã‚¢ã‚¯ã‚») åŸºç¤
            let totalAccBase = 0; 
            ['in_neck_base', 'in_finger_base', 'in_chest_base', 'in_belt_base', 'in_card_base', 'in_other_base', 'in_emblem_base', 'in_badge_base'].forEach(id => {
                totalAccBase += getNum(id);
            });
            totalAccBase += parseFloat(inputs.in_heart_select.value) || 0;

            // éŒ¬é‡‘åŠ¹æœ (Alchemy) ã®åˆè¨ˆã‚’ç®—å‡º
            let totalAlch = 0;
            ['in_neck_alch', 'in_finger_alch', 'in_chest_alch', 'in_belt_alch', 'in_card_alch', 'in_other_alch', 'in_emblem_alch', 'in_badge_alch', 'in_heart_alch'].forEach(id => {
                totalAlch += getNum(id);
            });
            totalAlch += getNum('in_set_alch');
            totalAlch += getNum('in_skill_alch');
            totalAlch += getNum('in_skill_150'); 

            // è¡¨ç¤ºç”¨åˆè¨ˆå€¤æ›´æ–°
            inputs.txtStrTotal.innerText = totalStrBase;
            // è£…å‚™åˆè¨ˆã¯ã€Œæ­¦å™¨å³ï¼‹ã‚¢ã‚¯ã‚»åŸºç¤ï¼‹ã‚¢ã‚¯ã‚»éŒ¬é‡‘ã€ã‚’è¡¨ç¤ºç”¨ã¨ã™ã‚‹
            let dispEquip = getNum('in_wepR_base') + getNum('in_wepR_alch') + totalAccBase + totalAlch; 
            inputs.txtEquipTotal.innerText = dispEquip;

            // --- ç´ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒã‚¤ã‚­å‰ï¼‰ ---
            // ä¼šå¿ƒå¼Aã§ä½¿ç”¨
            let rightBaseNoStr = totalAccBase + getNum('in_wepR_base');
            let rawRightAtk = totalStrBase + rightBaseNoStr + getNum('in_wepR_alch') + totalAlch;

            let leftStr = Math.floor(totalStrBase * 0.75);
            let leftBaseNoStr = totalAccBase + getNum('in_wepL_base');
            let rawLeftAtk = leftStr + leftBaseNoStr + getNum('in_wepL_alch') + totalAlch;

            // --- æ”»æ’ƒåŠ›ï¼ˆãƒã‚¤ã‚­å¾Œï¼‰ ---
            // ä¼šå¿ƒå¼Bã§ä»•æ§˜
            let atkR = 0;
            if (inputs.btnBaiki.classList.contains('active')) {
                // ãƒã‚¤ã‚­: åŸºç¤ x 1.4 + éŒ¬é‡‘
                let rb = totalStrBase + rightBaseNoStr;
                let ra = getNum('in_wepR_alch') + totalAlch;
                atkR = Math.floor(rb * 1.4) + ra;
            } else {
                atkR = rawRightAtk;
            }

            let atkL = 0;
            if (inputs.btnBaiki.classList.contains('active')) {
                // ãƒã‚¤ã‚­: åŸºç¤ x 1.4 + éŒ¬é‡‘
                let lb = leftStr + leftBaseNoStr;
                let la = getNum('in_wepL_alch') + totalAlch;
                atkL = Math.floor(lb * 1.4) + la;
            } else {
                atkL = rawLeftAtk;
            }

            inputs.displayAtkR.innerText = atkR;
            inputs.displayAtkL.innerText = atkL;

            let bossKey = inputs.calcBoss.value;
            let bossData = bosses[bossKey];
            let bossBaseDef = (bossData) ? bossData.def : 760;
            let finalDef = Math.floor(bossBaseDef * lukaniRate);
            inputs.displayDef.innerText = finalDef;

            currentHitBases = [];
            currentHitMinBases = [];
            currentHitMaxBases = [];
            
            currentHitCritBases = [];
            currentHitCritMinBases = [];
            currentHitCritMaxBases = [];
            
            currentHitCritMults = []; 
            currentHitIsLeft = []; 
            currentHitCritTypes = []; 
            currentHitCritInfo = []; 
            let totalBaseDmg = 0;

            if (!skillData) return;

            // ä¼šå¿ƒè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
            const calcCritBase = (rawAtk, effAtk, hitMult, isLeft, skillData) => {
                // ä¼šå¿ƒå¼ A: ç´ ã®æ”»æ’ƒåŠ› (ãƒã‚¤ã‚­å‰ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚‚ã®) * Min(Mult, 1.0)
                let multA = hitMult;
                if ((skillData.name.includes('éš¼') || skillData.name.includes('ãƒ„ãƒ¡')) && skillData.isNormal) {
                     multA = 1.0;
                } else {
                     if (multA > 1.0) multA = 1.0;
                }
                
                let compA = rawAtk * multA;

                // ä¼šå¿ƒå¼ B: åŸºç¤ãƒ€ãƒ¡ãƒ¼ã‚¸(from EffAtk) * 1.2 * Mult * (Left? 2.15)
                let baseComp = (effAtk / 2) - (finalDef / 4);
                if (baseComp < 1) baseComp = 1;
                let leftFactor = isLeft ? 2.15 : 1.0;
                
                let compB = baseComp * 1.2 * hitMult * leftFactor;

                // å¤§å°æ¯”è¼ƒ (without Orb)
                let type = (compA >= compB) ? 'A' : 'B';
                let finalVal = (type === 'A') ? compA : compB;

                return { 
                    val: finalVal, type: type,
                    valA: compA, baseA: rawAtk, multA: multA,
                    valB: compB, baseB: Math.floor(baseComp), multB: hitMult, left: leftFactor
                };
            };

            // Min/Maxã€€ç”Ÿæˆãƒ˜ãƒ«ãƒ‘
            // Random Range = Normal(0.9375-1.0625)
            // Crit Random Range = Normal(0.9375-1.0625) * Crit(0.95-1.05)
            const addHitData = (base, critBaseVal, critType, critInfoObj, critMult, isLeft = false) => {
                // Normal (Round)
                let minB = Math.round(base * 0.9375) - 1;
                let maxB = Math.round(base * 1.0625) + 1;
                if(minB < 1) minB = 1;
                if(maxB < 1) maxB = 1;
                
                // Crit (Normal Random Range * Crit Random Range)
                let minC = Math.round(critBaseVal * 0.9375) - 1;
                minC = Math.floor(minC * 0.95);
                let maxC = Math.round(critBaseVal * 1.0625) + 1;
                maxC = Math.floor(maxC * 1.05);
                if(minC < 1) minC = 1;
                if(maxC < 1) maxC = 1;

                currentHitBases.push(base);
                currentHitMinBases.push(minB);
                currentHitMaxBases.push(maxB);
                
                currentHitCritBases.push(critBaseVal);
                currentHitCritMinBases.push(minC);
                currentHitCritMaxBases.push(maxC);
                
                currentHitCritMults.push(critMult);
                currentHitIsLeft.push(isLeft);
                currentHitCritTypes.push(critType);
                currentHitCritInfo.push(critInfoObj);
                totalBaseDmg += base;
            };

            const addFixedHitData = (val, width, critMult) => {
                let center = val; 
                let minB = val - width;
                let maxB = val + width;

                // ä¼šå¿ƒæ™‚åŸºç¤: é€šå¸¸ã®1.2~1.6å€ (åˆ‡ã‚Šæ¨ã¦) 
                let critCenter = Math.floor(center * 1.4);
                let critMin = Math.floor(minB * 1.2);
                let critMax = Math.floor(maxB * 1.6);
                
                currentHitBases.push(center);
                currentHitMinBases.push(minB);
                currentHitMaxBases.push(maxB);
                
                currentHitCritBases.push(critCenter);
                currentHitCritMinBases.push(critMin);
                currentHitCritMaxBases.push(critMax);
                
                currentHitCritMults.push(critMult); 
                currentHitIsLeft.push(false);
                currentHitCritTypes.push('å›ºå®š1.4');
                currentHitCritInfo.push({ val: critCenter, type: 'å›ºå®š1.4', baseA: center });
                totalBaseDmg += center;
            };

            // Generate Hit Data
            if(skillData.type === 'fixed') {
                let fixedVal = skillData.val;
                let w = skillData.width || 0;
                let fixCritMult = (skillData.crit !== undefined) ? skillData.crit : 0; 
                
                for(let i=0; i<skillData.hits; i++){
                    addFixedHitData(fixedVal, w, fixCritMult);
                }
            } else {
                // Weapon Skill Logic
                const processHit = (rawAtkVal, effAtkVal, critMultiplier, hitMult, isLeft) => {
                    // Normal Damage
                    let base = (effAtkVal / 2) - (finalDef / 4);
                    if (base < 1) base = 1;
                    
                    let dmg = base * hitMult;
                    if(skillData.add) dmg += skillData.add;
                    
                    // Critical Damage Comparison
                    let cRes = calcCritBase(rawAtkVal, effAtkVal, hitMult, isLeft, skillData);
                    let cDmg = cRes.val;
                    if(skillData.add) cDmg += skillData.add;

                    // Pass full info object
                    addHitData(dmg, cDmg, cRes.type, cRes, critMultiplier, isLeft);
                };

                let mainCritMult = (skillData.crit !== undefined) ? skillData.crit : 1.0;
                let mainHits = skillData.hits || 1;
                
                if(skillData.name.includes('éš¼') || skillData.name.includes('ãƒãƒˆé€šå¸¸')) {
                    if(skillData.hits && Array.isArray(skillData.hits)){
                        skillData.hits.forEach(h => {
                           let useRaw = (h.t === 'L') ? rawLeftAtk : rawRightAtk;
                           let useEff = (h.t === 'L') ? atkL : atkR;
                           let isL = (h.t === 'L');
                           
                           processHit(useRaw, useEff, mainCritMult, h.m, isL);
                        });
                    }
                } else {
                    // Standard multi-hit weapon skill
                    let skillMult = skillData.mult || 1.0;
                    for(let i=0; i<mainHits; i++) {
                        processHit(rawRightAtk, atkR, mainCritMult, skillMult, false);
                    }
                    
                    // Left Hand Chaser for Bato Skills
                    if(skillData.batoLeft) {
                        processHit(rawLeftAtk, atkL, 0, skillMult, true); // CritMult 0 for left skill chaser
                    }
                }
            }

            inputs.base.value = Math.floor(totalBaseDmg);
            inputs.baseValDisplay.innerText = Math.floor(totalBaseDmg).toLocaleString();
            calculate();
        }

        function toggleBaiki(btn) {
            btn.classList.toggle('active');
            btn.innerText = btn.classList.contains('active') ? "ON" : "OFF";
            calcBaseDamage();
        }

        function setLukani(btn) {
            btn.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            lukaniRate = parseFloat(btn.dataset.lukani);
            calcBaseDamage();
        }

        function toggleBtn(btn) {
            const isNowActive = !btn.classList.contains('active'); 
            const exclusiveGroup = btn.dataset.exclusive; 
            if (exclusiveGroup && isNowActive) {
                document.querySelectorAll(`button[data-exclusive="${exclusiveGroup}"]`).forEach(b => {
                    b.classList.remove('active');
                });
            }
            if (isNowActive) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            calculate();
        }

        function getBeamColor(value, max) {
            let ratio = Math.min(value / max, 1.3); 
            let hue = 210 - (ratio * 210);
            let saturation = 90;
            let lightness = 60;
            if (hue < 0) {
                hue = 360 + hue; 
                saturation = 100;
                lightness = 70;
            }
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function calculate() {
            const sKey = inputs.calcSkillSelect.value;
            const skillData = skills[sKey];
            
            // --- Multipliers ---
            let attrMag = 1.0;
            let mergedAdd = 0.0;
            
            attrMag += parseFloat(inputs.attrBelt.value) 
                    + parseFloat(inputs.attrRing.value)
                    + parseFloat(inputs.attrHeart.value)
                    + parseFloat(inputs.attrWepBase.value);
            
            mergedAdd += parseFloat(inputs.raceBelt.value);
            mergedAdd += parseFloat(inputs.raceRing.value);
            mergedAdd += parseFloat(inputs.raceWepBase.value);
            
            mergedAdd += parseFloat(inputs.classBonus.value);
            if(inputs.btnForceNorm.classList.contains('active')) mergedAdd += 0.1;

            document.querySelectorAll('.group-dmg.active, .group-mr.active').forEach(btn => {
                mergedAdd += parseFloat(btn.dataset.val);
            });

            // Orb (Calculate here but apply in mergedMag)
            let orbVal = (skillData && skillData.orb) ? (skillData.orb/100) : 0;
            mergedAdd += orbVal;

            const orbBadge = document.getElementById('orbBadge');
            if(orbVal > 0){
                orbBadge.innerText = `ğŸ’å®ç  +${skillData.orb}%`;
                orbBadge.classList.add('active');
            } else {
                orbBadge.innerText = `ğŸ’å®ç  0%`;
                orbBadge.classList.remove('active');
            }

            let mergedMag = 1.0 + mergedAdd;

            let takenAdd = 0;
            document.querySelectorAll('.group-taken.active').forEach(btn => {
                takenAdd += parseFloat(btn.dataset.val);
            });
            let takenMag = 1.0 + takenAdd;

            let fbAdd = 0;
            document.querySelectorAll('.group-fb.active, .group-down.active').forEach(btn => {
                fbAdd += parseFloat(btn.dataset.val);
            });

            // ãƒœã‚¹å±æ€§è€æ€§
            const currentBossKey = document.getElementById('calcBoss').value;
            const currentElement = document.getElementById('attackElement').value;
            
            let baseResist = 1.0;
            // bossDataãŒå­˜åœ¨ã—ã€ã‹ã¤resistå®šç¾©ãŒã‚ã‚‹ã‹ç¢ºèª
            if (bosses[currentBossKey] && bosses[currentBossKey].resist) {
                baseResist = bosses[currentBossKey].resist[currentElement];
            }
            
            //document.getElementById('bossResistDisplay').innerText = `${baseResist.toFixed(2)}å€`;

            let fbMag = baseResist + fbAdd;
            
            // --- Add Damage Logic ---
            let jobKey = inputs.calcJob.value;
            let wepKey = inputs.calcWeapon.value;
            let wepType = (weapons[wepKey]) ? weapons[wepKey].type : '';
            
            let skillAdd = parseInt(inputs.skillAddDmg.value) || 0; 
            
            // Job Specific Add
            let jobAddDmg = 0;
            let jobAddCrit = 85; 
            let isTokugi = !skillData.isNormal; 

            if(jobKey === 'bato' && wepType === 'sword') {
                if(isTokugi) jobAddDmg += 20;
                jobAddCrit += 50; 
            }
            if(jobKey === 'dougu' && wepType === 'spear' && isTokugi) {
                jobAddDmg += 50;
            }
            if(jobKey === 'gad' && wepType === 'spear' && isTokugi) {
                jobAddDmg += 40;
            }
            
            let finalAddNorm = (isTokugi ? skillAdd : 0) + jobAddDmg;
            let finalAddCrit = finalAddNorm + jobAddCrit;

            // --- Calculation Loop ---
            let expectedTotal = 0; 
            let hitDetails = []; 

            // Beams Sums (Cumulative)
            let sumD1=0, sumD2=0, sumD3=0, sumD4=0, sumD5=0;
            let sumRaw = 0;

            let dmgCap = (skillData.cap) ? skillData.cap : 9999;

            let rawCritRate = parseFloat(inputs.critRate.value) || 0;
            if(inputs.btnCritBuff.classList.contains('active')) rawCritRate += 15.0;
            const btnGadget = document.getElementById('btnGadget');
            if (btnGadget && btnGadget.classList.contains('active')) rawCritRate += 10.0;

            let dispText = `åŸºæº–ç‡: ${rawCritRate.toFixed(2)}%`;
            if (skillData.crit !== 1.0 && skillData.crit !== undefined) dispText += ` (åŸºæœ¬è£œæ­£ x${skillData.crit})`;
            document.getElementById('critDisplay').innerText = dispText;

            // Process Hits
            for(let i=0; i<currentHitBases.length; i++) {
                let baseMin = currentHitMinBases[i];
                let baseMed = currentHitBases[i];
                let baseMax = currentHitMaxBases[i];
                
                let critBaseMin = currentHitCritMinBases[i];
                let critBaseMed = currentHitCritBases[i];
                let critBaseMax = currentHitCritMaxBases[i];
                
                let hitCritMult = (currentHitCritMults[i] !== undefined) ? currentHitCritMults[i] : 1.0;
                let isLeft = (currentHitIsLeft[i] !== undefined) ? currentHitIsLeft[i] : false;
                let cType = (currentHitCritTypes[i]) ? currentHitCritTypes[i] : '';
                
                let cInfo = currentHitCritInfo[i] || {};

                // Function to apply multipliers
                const calcStep = (val, isCrit) => {
                    let v = Math.floor(val);
                    let v2, v3, v4, v5;

                    v2 = Math.floor(v * attrMag);
                    v3 = Math.floor(v2 * mergedMag); 
                    v4 = Math.floor(v3 * takenMag); 
                    v5 = Math.floor(v4 * fbMag);
                    
                    return v5 + (isCrit ? finalAddCrit : finalAddNorm);
                };

                // For Beam Visualization
                let b_v1 = Math.floor(baseMed);
                let b_v2 = Math.floor(b_v1 * attrMag);
                let b_v3 = Math.floor(b_v2 * mergedMag);
                let b_v4 = Math.floor(b_v3 * takenMag);
                let b_v5 = Math.floor(b_v4 * fbMag) + finalAddNorm;
                
                sumD1 += b_v1; sumD2 += b_v2; sumD3 += b_v3; sumD4 += b_v4; sumD5 += b_v5;

                // 1. Normal Damage Range
                let n_min_raw = calcStep(baseMin, false);
                let n_med_raw = calcStep(baseMed, false);
                let n_max_raw = calcStep(baseMax, false);
                let n_med_cap = (n_med_raw > dmgCap) ? dmgCap : n_med_raw;
                
                // 2. Crit Damage Range
                let c_min_raw = calcStep(critBaseMin, true);
                let c_med_raw = calcStep(critBaseMed, true);
                let c_max_raw = calcStep(critBaseMax, true);
                let c_med_cap = (c_med_raw > dmgCap) ? dmgCap : c_med_raw;

                // 3. Expected Value
                let effectiveCritRate = rawCritRate * hitCritMult;
                if(effectiveCritRate > 100) effectiveCritRate = 100;
                if(effectiveCritRate < 0) effectiveCritRate = 0;
                let cRate = effectiveCritRate / 100.0;

                let exp = (n_med_cap * (1.0 - cRate)) + (c_med_cap * cRate);
                expectedTotal += Math.floor(exp);
                sumRaw += n_med_raw; 

                // Process Info for display (apply final mults to A/B base)
                let cFinalA = 0;
                let cFinalB = 0;
                if (cInfo.valA) cFinalA = calcStep(cInfo.valA, true);
                if (cInfo.valB) cFinalB = calcStep(cInfo.valB, true);

                // Store detail
                hitDetails.push({
                    idx: i+1,
                    base_med: Math.floor(baseMed), 
                    n_min: n_min_raw, n_med: n_med_raw, n_max: n_max_raw,
                    c_min: c_min_raw, c_med: c_med_raw, c_max: c_max_raw,
                    cap: dmgCap,
                    is_left: isLeft,
                    c_type: cType,
                    crit_info: cInfo,
                    c_final_a: cFinalA,
                    c_final_b: cFinalB
                });
            }
            
            // Expected Value Display
            const finalEl = document.getElementById('finalResult');
            finalEl.innerText = expectedTotal.toLocaleString();
            
            // Update Floating Popup
            document.getElementById('wipeResult').innerText = expectedTotal.toLocaleString();

            let pureMult = attrMag * mergedMag * takenMag * fbMag;
            document.getElementById('totalMult').innerText = `x ${pureMult.toFixed(2)} å€ (åˆè¨ˆ)`;

            // Beams
            const maxRef = 50000; 
            const values = [sumD1, sumD2, sumD3, sumD4, sumD5];
            for (let i = 0; i < 5; i++) {
                if (beams[i]) {
                    let val = values[i];
                    let widthRatio = Math.sqrt(val) / Math.sqrt(maxRef);
                    let width = Math.max(BASE_WIDTH_PX, Math.min(widthRatio * MAX_WIDTH_PX * 2.2, MAX_WIDTH_PX));
                    let color = getBeamColor(val, maxRef);
                    beams[i].style.width = width + "px";
                    beams[i].style.backgroundColor = color;
                    beams[i].style.boxShadow = `0 0 ${10 + width/4}px ${color}`;
                }
                if (resultLabels[i]) {
                    let desc = "";
                    if(i===1) desc = `Ã—å±æ€§(x${attrMag.toFixed(2)})`;
                    if(i===2) desc = `Ã—å¼·åŒ–åˆè¨ˆ(x${mergedMag.toFixed(2)})`;
                    if(i===3) desc = `Ã—è¢«ãƒ€ãƒ¡å¢—(x${takenMag.toFixed(1)})`;
                    if(i===4) desc = `Ã—è€æ€§ä½ä¸‹(x${fbMag.toFixed(1)})`;
                    let v = values[i]; 
                    resultLabels[i].innerHTML = `${v.toLocaleString()}<small>${desc}</small>`;
                }
            }

            // Pack Multipliers
            const calcDebugInfo = {
                attr: attrMag,
                race: mergedMag,
                taken: takenMag,
                fb: fbMag,
                add: finalAddNorm
            };

            renderDetail(hitDetails, skillData, calcDebugInfo);
            updateDiff(expectedTotal);
        }

        function renderDetail(details, skillData, mults) {
            const container = document.getElementById('randomDetail');
            
            let groups = [];
            if(details.length > 0) {
                let current = details[0];
                let count = 1;
                for(let i=1; i<details.length; i++) {
                    let d = details[i];
                    // Group if all stats match
                    if(d.n_med === current.n_med && d.n_min === current.n_min && d.n_max === current.n_max && 
                       d.c_med === current.c_med && d.base_med === current.base_med && 
                       d.is_left === current.is_left && d.c_type === current.c_type) {
                        count++;
                    } else {
                        groups.push({data: current, count: count});
                        current = d;
                        count = 1;
                    }
                }
                groups.push({data: current, count: count});
            }

            let html = '';
            groups.forEach((g, i) => {
                let d = g.data;
                
                let handLabel = d.is_left ? `<span class="hand-tag hand-l">(å·¦æ‰‹)</span>` : "";
                let typeLabel = d.c_type ? `<span class="c-type">(${d.c_type})</span>` : "";

                let title = `Hit ${i+1}${handLabel}`;
                if(g.count > 1) title += ` ï½ ${i+g.count} (x${g.count}å›)`;
                
                let nStyle = (d.n_max > d.cap) ? "color:#ff00ff;" : "";
                let cStyle = (d.c_max > d.cap) ? "color:#ff00ff;" : "color:#ff2a6d;";

                let baseLabel = d.is_left ? "åŸºç¤(å·¦)" : "åŸºç¤";
                let processStr = "";
                if (mults) {
                    processStr = 
                        `<span class="process-tag">[è¨ˆç®—å¼]</span>` +
                        `${baseLabel}${d.base_med} ` +
                        `Ã— å±${mults.attr.toFixed(2)} ` +
                        `Ã— å¼·${mults.race.toFixed(2)} ` +
                        `Ã— è¢«${mults.taken.toFixed(2)} ` +
                        `Ã— FB${mults.fb.toFixed(1)} ` +
                        `+ åŠ ${mults.add} ` +
                        `= ${d.n_med}`;
                    
                    // Show Crit Compare with Full Details (Single Line)
                    if (d.crit_info && d.c_type !== 'å›ºå®š1.4') {
                        let ci = d.crit_info;
                        let rowAClass = (d.c_type === 'A') ? "crit-row selected" : "crit-row";
                        let rowBClass = (d.c_type === 'B') ? "crit-row selected" : "crit-row";
                        let markA = (d.c_type === 'A') ? '<span style="color:#ff2a6d;">(æ¡ç”¨)</span>' : '';
                        let markB = (d.c_type === 'B') ? '<span style="color:#ff2a6d;">(æ¡ç”¨)</span>' : '';

                        let leftInfo = ci.left > 1.0 ? `Ã— å·¦ç‰¹æ®Š${ci.left.toFixed(2)} ` : '';

                        processStr += `
                        <div class="crit-compare-block">
                            <div class="${rowAClass}">
                                <span class="crit-tag">å¼A</span> 
                                <span class="crit-detail">æ”»(ï¾Šï¾ï½²ï½·å‰)${ci.baseA} Ã— å€ç‡${ci.multA.toFixed(2)} = åŸºç¤${Math.floor(ci.valA).toLocaleString()}</span>
                                <span class="crit-arrow">â†’</span>
                                <span class="crit-result-part">æœ€çµ‚${d.c_final_a.toLocaleString()} ${markA}</span>
                            </div>
                            <div class="${rowBClass}">
                                <span class="crit-tag">å¼B</span> 
                                <span class="crit-detail">åŸºç¤${ci.baseB} Ã— å€ç‡${ci.multB.toFixed(2)} Ã— ä¼šï¾ï¾ï½°ï¾…ï½½1.2 ${leftInfo}= åŸºç¤${Math.floor(ci.valB).toLocaleString()}</span>
                                <span class="crit-arrow">â†’</span>
                                <span class="crit-result-part">æœ€çµ‚${d.c_final_b.toLocaleString()} ${markB}</span>
                            </div>
                        </div>
                        `;
                    } else if (d.c_type === 'å›ºå®š1.4') {
                        processStr += `<br><span class="process-tag" style="color:#ff2a6d;">[ä¼šå¿ƒå›ºå®š]</span>` +
                        `åŸºç¤${d.crit_info.baseA} ` +
                        `Ã— 1.2~1.6`;
                    }
                }

                html += `
                <div class="hit-row">
                    <div class="hit-header">${title}</div>
                    <div class="hit-vals">
                        <span class="v-label">é€šå¸¸:</span>
                        <span class="v-num" style="${nStyle}">${d.n_min.toLocaleString()} ~ ${d.n_max.toLocaleString()} <small>(${d.n_med.toLocaleString()})</small></span>
                        <span class="v-label">ä¼šå¿ƒ${typeLabel}:</span>
                        <span class="v-num" style="${cStyle} font-weight:bold;">${d.c_min.toLocaleString()} ~ ${d.c_max.toLocaleString()} <small>(${d.c_med.toLocaleString()})</small></span>
                    </div>
                    <div class="process-info">${processStr}</div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        document.querySelectorAll('input, select').forEach(el => {
            if(!el.id.startsWith('calc')) {
                el.addEventListener('input', calculate);
            }
        });

        document.getElementById('detailStats').querySelectorAll('input, select').forEach(el => {
            el.addEventListener('input', calcBaseDamage);
        });
        document.getElementById('critRate').addEventListener('input', calculate);

        function saveSnapshot() {
            const current = parseInt(document.getElementById('finalResult').innerText.replace(/,/g, ''));
            snapshotDamage = current;
            document.getElementById('diffDisplay').style.display = "block";
            document.getElementById('snapshotVal').innerText = current.toLocaleString();
            updateDiff(current);
        }

        function updateDiff(currentVal) {
            if (snapshotDamage === null) return;
            const diff = currentVal - snapshotDamage;
            const diffEl = document.getElementById('diffVal');
            
            if (diff > 0) {
                diffEl.innerText = `â–² ${diff.toLocaleString()} UP!`;
                diffEl.className = "diff-plus";
            } else if (diff < 0) {
                diffEl.innerText = `â–¼ ${diff.toLocaleString()} DOWN`;
                diffEl.className = "diff-minus";
            } else {
                diffEl.innerText = "Â±0";
                diffEl.className = "diff-even";
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.querySelector('.theme-toggle');
            
            if (html.getAttribute('data-theme') === 'light') {
                html.removeAttribute('data-theme'); // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)ã¸
                btn.innerText = 'ğŸŒ™';
                btn.style.background = ""; 
            } else {
                html.setAttribute('data-theme', 'light'); // ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã¸
                btn.innerText = 'â˜€ï¸';
                btn.style.background = "#fff"; 
            }
        }

        init();

    </script>
</body>
</html>



